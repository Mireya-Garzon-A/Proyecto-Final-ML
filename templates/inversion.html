{% extends "base.html" %}
{% block title %}Inversi√≥n Ganadera por Departamento{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
  <h2 class="text-center fw-bold text-primary mb-4">üìä An√°lisis del Censo Bovino 2025</h2>

  <div class="row g-3 justify-content-center">
    <!-- Tarjeta 1 -->
    <div class="col-md-4">
      <div class="card h-100 border-success shadow-sm">
        <div class="card-header bg-success text-white fw-bold">üêÑ Mayores por grupo etario</div>
        <div class="card-body">
          {% for item in analisis.mayores %}
          <p><strong>{{ item.grupo }}:</strong> {{ item.departamento }} ‚Äì {{ item.cantidad | int }}</p>
          {% endfor %}
          <p class="text-muted small">ANTIOQUIA lidera en todos los rangos, lo que indica una estructura ganadera robusta y continua.</p>
        </div>
      </div>
    </div>

    <!-- Tarjeta 2 -->
    <div class="col-md-4">
      <div class="card h-100 border-danger shadow-sm">
        <div class="card-header bg-danger text-white fw-bold">üêÑ Menores por grupo etario</div>
        <div class="card-body">
          {% for item in analisis.menores %}
          <p><strong>{{ item.grupo }}:</strong> {{ item.departamento }} ‚Äì {{ item.cantidad | int }}</p>
          {% endfor %}
          <p class="text-muted small">Esto refleja una baja vocaci√≥n ganadera en zonas insulares.</p>
        </div>
      </div>
    </div>

    <!-- Tarjeta 3 -->
    <div class="col-md-4">
      <div class="card h-100 border-primary shadow-sm">
        <div class="card-header bg-primary text-white fw-bold">üìä Distribuci√≥n nacional</div>
        <div class="card-body">
          {% for grupo, porcentaje in analisis.distribucion.items() %}
          <p><strong>{{ grupo }}:</strong> {{ porcentaje }}%</p>
          {% endfor %}
          <p class="text-muted small">Distribuci√≥n porcentual del total nacional por grupo etario.</p>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Bot√≥n para ver tabla completa -->
<div class="text-center mb-5">
  <button class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#modalCenso">
    üìã Ver datos completos del censo
  </button>
</div>

<!-- Modal con tabla completa -->
<div class="modal fade" id="modalCenso" tabindex="-1" aria-labelledby="modalCensoLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalCensoLabel">üìã Censo Bovino 2025 ‚Äì Datos completos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          {{ tabla_censo|safe }}
        </div>
      </div>
    </div>
  </div>
</div>


  <!-- Selecci√≥n de raza y n√∫mero de vacas (reemplaza selector de departamento) -->
  <form method="POST" class="p-4 bg-light rounded shadow-sm mb-4" id="formAnalisis">
    <div class="row g-3 align-items-end">
      <div class="col-md-6">
        <label for="raza_top" class="form-label fw-semibold text-primary">Selecciona una raza</label>
        <select name="raza" id="raza_top" class="form-select">
          <option value="">-- Elige una raza --</option>
          {% for r in razas %}
          <option value="{{ r }}" {% if r == raza_sel %}selected{% endif %}>{{ r }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label for="num_vacas_top" class="form-label fw-semibold text-primary"># Vacas</label>
        <input type="number" name="num_vacas" id="num_vacas_top" class="form-control" min="1" value="{{ num_vacas or '' }}" required>
       
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100" id="btnAnalizar">üîé Analizar</button>
      </div>
    </div>
  </form>

  {% if input_error %}
    <div class="alert alert-danger">{{ input_error }}</div>
  {% endif %}

    {% if region %}

    <!-- Informaci√≥n de la regi√≥n -->
    <div class="row g-3">
  <div class="col-md-6">
    <div class="card border-success">
      <div class="card-header bg-success text-white">Regi√≥n 1</div>
      <div class="card-body">
        {% for d in departamentos_region if region == 1 %}
        <span class="badge bg-light text-dark me-1 mb-1">{{ d }}</span>
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card border-primary">
      <div class="card-header bg-primary text-white">Regi√≥n 2</div>
      <div class="card-body">
        {% for d in departamentos_region if region == 2 %}
        <span class="badge bg-light text-dark me-1 mb-1">{{ d }}</span>
        {% endfor %}
      </div>
    </div>
  </div>
</div>


        <div class="col-md-6">
            <div class="p-3 bg-white border rounded shadow-sm">
                <h5 class="fw-bold text-success">üêÑ Razas disponibles</h5>
                <ul class="list-group">
                    {% for r in razas_region %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>{{ r['razas'] }}</span>
                        <span class="text-muted">{{ r['volumen diario'] }} litros/d√≠a</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- (Se elimin√≥ formulario duplicado) -->
    {% endif %}

    {% if volumen_diario %}
    <!-- Resultados -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="p-3 bg-white border rounded shadow-sm">
                <h5 class="fw-bold text-success">üíß Producci√≥n estimada</h5>
                <ul class="list-group">
                    <li class="list-group-item">Volumen diario total: <strong>{{ volumen_diario }} litros</strong></li>
                    <li class="list-group-item">Volumen mensual estimado: <strong>{{ volumen_mensual }} litros</strong></li>
                </ul>
            </div>
        </div>
    <!-- Se elimin√≥ la tarjeta "Mejor mes para vender" a petici√≥n del usuario -->
    </div>

    <!-- Mejor departamento / regi√≥n y meses recomendados -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card border-secondary">
          <div class="card-header bg-secondary text-white fw-bold">üèÜ Mejor ubicaci√≥n para la raza seleccionada</div>
          <div class="card-body">
            <p><strong>Mejor departamento:</strong> {{ mejor_depto or 'No disponible' }}</p>
            <p><strong>Mejor regi√≥n:</strong> {{ mejor_region or 'No disponible' }}</p>
            <p class="text-muted small">Departamento seleccionado seg√∫n mayor rendimiento por vaca para la raza escogida.</p>
            {% if lista_mejores_info %}
            <hr>
            <h6 class="mt-2">Top departamentos (producci√≥n estimada para la cantidad indicada)</h6>
            <div class="table-responsive">
              <table class="table table-sm table-striped">
                <thead>
                  <tr>
                    <th>Departamento</th>
                    <th>Regi√≥n</th>
                    <th>Volumen / vaca (L)</th>
                    <th>Prod. diaria (L)</th>
                    <th>Prod. mensual (L)</th>
                  </tr>
                </thead>
                <tbody>
                  {% for i in lista_mejores_info %}
                  <tr>
                    <td>{{ i.departamento }}</td>
                    <td>{{ i.region }}</td>
                    <td>{{ i.volumen_por_vaca | round(2) }}</td>
                    <td>{{ i.prod_diaria | round(2) }}</td>
                    <td>{{ i.prod_mensual | round(2) }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card border-dark">
          <div class="card-header bg-dark text-white fw-bold">üìÖ Mejores meses para producci√≥n</div>
          <div class="card-body">
            <p class="mb-1"><strong>A nivel nacional:</strong></p>
            {% if meses_recomendados %}
              {% for m in meses_recomendados %}
                <div class="small">{{ m.mes }} <span class="text-muted">({{ m.valor | round(0) }})</span></div>
                <div class="progress mb-2" style="height:8px;">
                  <div class="progress-bar bg-info" role="progressbar" data-pct="{{ m.pct | round(1) }}" aria-valuenow="{{ m.valor }}" aria-valuemin="0" aria-valuemax="{{ meses_recomendados_max }}"></div>
                </div>
              {% endfor %}
            {% else %}
              <p>No disponible</p>
            {% endif %}

            <hr>
            <p class="mb-1"><strong>Para el departamento recomendado:</strong></p>
            {% if meses_depto %}
              {% for m in meses_depto %}
                <div class="small">{{ m.mes }} <span class="text-muted">({{ m.valor | round(0) }})</span></div>
                <div class="progress mb-2" style="height:8px;">
                  <div class="progress-bar bg-success" role="progressbar" data-pct="{{ m.pct | round(1) }}" aria-valuenow="{{ m.valor }}" aria-valuemin="0" aria-valuemax="{{ meses_depto_max }}"></div>
                </div>
              {% endfor %}
            {% else %}
              <p>No disponible</p>
            {% endif %}

            <p class="text-muted small">Meses calculados a partir del hist√≥rico de acopio (DataSheet).</p>
          </div>
        </div>
      </div>
    </div>

<!-- Se elimin√≥ la ventana emergente de an√°lisis seg√∫n petici√≥n del usuario. Los cuadros de resultados permanecen en la p√°gina. -->

    
<!-- Se eliminaron las tarjetas de 'Predicci√≥n de Acopio Mensual' y 'Mes m√°s rentable (ML)' a petici√≥n del usuario. -->

    {% endif %}

</div>
<script>
  // Cliente: set progress bar widths from data-pct y validar formulario
  document.addEventListener('DOMContentLoaded', function () {
    // Set progress widths
    document.querySelectorAll('.progress-bar[data-pct]').forEach(function(el){
      const pct = parseFloat(el.getAttribute('data-pct')) || 0;
      el.style.width = pct + '%';
    });

    // Form validation
    const form = document.getElementById('formAnalisis');
    const numVacasInput = document.getElementById('num_vacas_top');
    const razaSelect = document.getElementById('raza_top');
    const numVacasError = document.getElementById('numVacasError');

    if (form) {
      form.addEventListener('submit', function(e){
        let valid = true;
        numVacasError.style.display = 'none';

        // raza debe seleccionarse
        if (!razaSelect.value) {
          valid = false;
          razaSelect.classList.add('is-invalid');
        } else {
          razaSelect.classList.remove('is-invalid');
        }

        // num vacas debe ser entero > 0
        const nv = parseInt(numVacasInput.value, 10);
        if (!nv || nv <= 0) {
          valid = false;
          numVacasError.style.display = 'block';
        }

        if (!valid) {
          e.preventDefault();
          e.stopPropagation();
        }
      });
    }
  });
</script>

{% endblock %}
