{% extends "base.html" %}
{% block title %}Inversi√≥n Ganadera por Departamento{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
  <h2 class="text-center fw-bold text-primary mb-4">üìä An√°lisis del Censo Bovino 2025</h2>

  <div class="row g-3 justify-content-center">
    <!-- Tarjeta 1 -->
    <div class="col-md-4">
      <div class="card h-100 border-success shadow-sm">
        <div class="card-header bg-success text-white fw-bold">üêÑ Mayores por grupo etario</div>
        <div class="card-body">
          {% for item in analisis.mayores %}
          <p><strong>{{ item.grupo }}:</strong> {{ item.departamento }} ‚Äì {{ item.cantidad | int }}</p>
          {% endfor %}
          <p class="text-muted small">ANTIOQUIA lidera en todos los rangos, lo que indica una estructura ganadera robusta y continua.</p>
        </div>
      </div>
    </div>

    <!-- Tarjeta 2 -->
    <div class="col-md-4">
      <div class="card h-100 border-danger shadow-sm">
        <div class="card-header bg-danger text-white fw-bold">üêÑ Menores por grupo etario</div>
        <div class="card-body">
          {% for item in analisis.menores %}
          <p><strong>{{ item.grupo }}:</strong> {{ item.departamento }} ‚Äì {{ item.cantidad | int }}</p>
          {% endfor %}
          <p class="text-muted small">Esto refleja una baja vocaci√≥n ganadera en zonas insulares.</p>
        </div>
      </div>
    </div>

    <!-- Tarjeta 3 -->
    <div class="col-md-4">
      <div class="card h-100 border-primary shadow-sm">
        <div class="card-header bg-primary text-white fw-bold">üìä Distribuci√≥n nacional</div>
        <div class="card-body">
          {% for grupo, porcentaje in analisis.distribucion.items() %}
          <p><strong>{{ grupo }}:</strong> {{ porcentaje }}%</p>
          {% endfor %}
          <p class="text-muted small">Distribuci√≥n porcentual del total nacional por grupo etario.</p>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Bot√≥n para ver tabla completa -->
<div class="text-center mb-5">
  <button class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#modalCenso">
    üìã Ver datos completos del censo
  </button>
</div>

<!-- Modal con tabla completa -->
<div class="modal fade" id="modalCenso" tabindex="-1" aria-labelledby="modalCensoLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalCensoLabel">üìã Censo Bovino 2025 ‚Äì Datos completos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          {{ tabla_censo|safe }}
        </div>
      </div>
    </div>
  </div>
</div>


  <!-- Selecci√≥n de raza y n√∫mero de vacas (reemplaza selector de departamento) -->
  <form method="POST" class="p-4 bg-light rounded shadow-sm mb-4" id="formAnalisis">
    <div class="row g-3 align-items-end">
      <div class="col-md-5">
        <label for="raza_top" class="form-label fw-semibold text-primary">Selecciona una raza</label>
        <select name="raza" id="raza_top" class="form-select">
          <option value="">-- Elige una raza --</option>
          {% for r in razas %}
          <option value="{{ r }}" {% if r == raza_sel %}selected{% endif %}>{{ r }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label for="anio_top" class="form-label fw-semibold text-primary">A√±o</label>
        <select name="anio" id="anio_top" class="form-select">
          {% if available_years %}
            {% for y in available_years %}
            <option value="{{ y }}" {% if y == anio_sel %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          {% else %}
            <option value="2025" {% if anio_sel == 2025 %}selected{% endif %}>2025</option>
          {% endif %}
        </select>
      </div>
      <div class="col-md-2">
        <label for="num_vacas_top" class="form-label fw-semibold text-primary"># Vacas</label>
        <input type="number" name="num_vacas" id="num_vacas_top" class="form-control" min="1" value="{{ num_vacas or '' }}" required>
        <div id="numVacasError" class="invalid-feedback" style="display:none">Ingrese un n√∫mero entero mayor que 0.</div>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100" id="btnAnalizar">üîé Analizar</button>
      </div>
    </div>
  </form>

  {% if input_error %}
    <div class="alert alert-danger">{{ input_error }}</div>
  {% endif %}

    {% if region %}

    <!-- Informaci√≥n de la regi√≥n -->
    <div class="row g-3">
  <div class="col-md-6">
    <div class="card border-success">
      <div class="card-header bg-success text-white">Regi√≥n 1</div>
      <div class="card-body">
        {% for d in departamentos_region if region == 1 %}
        <span class="badge bg-light text-dark me-1 mb-1">{{ d }}</span>
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card border-primary">
      <div class="card-header bg-primary text-white">Regi√≥n 2</div>
      <div class="card-body">
        {% for d in departamentos_region if region == 2 %}
        <span class="badge bg-light text-dark me-1 mb-1">{{ d }}</span>
        {% endfor %}
      </div>
    </div>
  </div>
</div>


        <div class="col-md-6">
            <div class="p-3 bg-white border rounded shadow-sm">
                <h5 class="fw-bold text-success">üêÑ Razas disponibles</h5>
                <ul class="list-group">
                    {% for r in razas_region %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>{{ r['razas'] }}</span>
                        <span class="text-muted">{{ r['volumen diario'] }} litros/d√≠a</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- (Se elimin√≥ formulario duplicado) -->
    {% endif %}

    {% if volumen_diario %}
    <!-- Resultados: Producci√≥n estimada y Precio de venta (√∫ltimo) lado a lado -->
    <div class="row mb-4 justify-content-center">
      <div class="col-md-6">
        <div class="p-3 bg-white border rounded shadow-sm text-center">
          <h5 class="fw-bold text-success">üíß Producci√≥n estimada{% if num_vacas %} ‚Äî {{ num_vacas }} {{ 'vaca' if num_vacas|int == 1 else 'vacas' }}{% endif %}</h5>
          {% if breed_stats %}
            <hr>
            <h6 class="fw-semibold">Datos de la raza: {{ raza_sel }}</h6>
            <div class="table-responsive">
              {{ breed_table_html | safe }}
            </div>
          {% endif %}
        </div>
      </div>
      <div class="col-md-4">
        <div class="p-3 bg-white border rounded shadow-sm">
          <h6 class="fw-bold text-primary">üí∞ Precio de venta (√∫ltimo registro)</h6>
          <p class="small text-muted">Se muestran los precios m√°s recientes solo para los departamentos recomendados (m√°x. 3).</p>
          <ul class="list-group list-group-flush">
            {% if precios_departamentos %}
              {% for p in precios_departamentos %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>{{ p.departamento }}</span>
                  <span class="badge bg-success rounded-pill">{{ p.precio_str }} COP</span>
                </li>
              {% endfor %}
            {% else %}
              <li class="list-group-item">No hay datos de precios disponibles.</li>
            {% endif %}
          </ul>
          <p class="text-muted small mt-2">Fuente: dataset de precios en DataSheet (√∫ltimo registro disponible).</p>
        </div>
      </div>
    </div>

    <!-- Mejor departamento / regi√≥n y meses recomendados -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card border-dark">
          <div class="card-header bg-dark text-white fw-bold">üìÖ Mejores meses para producci√≥n</div>
          <div class="card-body">
            <p class="mb-1"><strong>A nivel nacional:</strong></p>
            {% if meses_recomendados %}
              {% for m in meses_recomendados %}
                <div class="small">{{ m.mes }} <span class="text-muted">({{ m.valor | round(0) }})</span></div>
                <div class="progress mb-2" style="height:8px;">
                  <div class="progress-bar bg-info" role="progressbar" data-pct="{{ m.pct | round(1) }}" aria-valuenow="{{ m.valor }}" aria-valuemin="0" aria-valuemax="{{ meses_recomendados_max }}"></div>
                </div>
              {% endfor %}
            {% else %}
              <p>No disponible</p>
            {% endif %}

            <hr>
            <p class="mb-1"><strong>Para el departamento recomendado:</strong></p>
            {% if meses_depto %}
              {% for m in meses_depto %}
                <div class="small">{{ m.mes }} <span class="text-muted">({{ m.valor | round(0) }})</span></div>
                <div class="progress mb-2" style="height:8px;">
                  <div class="progress-bar bg-success" role="progressbar" data-pct="{{ m.pct | round(1) }}" aria-valuenow="{{ m.valor }}" aria-valuemin="0" aria-valuemax="{{ meses_depto_max }}"></div>
                </div>
              {% endfor %}
            {% else %}
              <p>No disponible</p>
            {% endif %}

            <p class="text-muted small">Meses calculados a partir del hist√≥rico de acopio (DataSheet).</p>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card border-secondary">
          <div class="card-header bg-secondary text-white fw-bold">üèÜ Mejor ubicaci√≥n para la raza seleccionada</div>
          <div class="card-body">
            <p><strong>Mejor departamento:</strong> {{ mejor_depto or 'No disponible' }}</p>
            <p><strong>Mejor regi√≥n:</strong> {{ mejor_region or 'No disponible' }}</p>
            <p class="text-muted small">Departamento seleccionado seg√∫n mayor rendimiento por vaca para la raza escogida.</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Gr√°ficos anuales por departamento recomendado -->
    {% if lista_mejores_series %}
    <div class="row mt-4">
      {% for s in lista_mejores_series %}
      <div class="col-md-6 mb-3">
        <div class="card h-100 border-info">
          <div class="card-header bg-info text-white fw-bold">üìà Acopio anual - {{ s.departamento }} ({{ s.year }})</div>
          <div class="card-body">
            {% if not s.has_data %}
              <div class="alert alert-warning">No hay datos de acopio para <strong>{{ s.departamento }}</strong> en {{ s.year }}. No hay registros en la base de datos para este a√±o; por eso no se muestra el gr√°fico.</div>
            {% else %}
              <canvas id="chart-{{ loop.index0 }}" height="160"></canvas>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

<!-- Se elimin√≥ la ventana emergente de an√°lisis seg√∫n petici√≥n del usuario. Los cuadros de resultados permanecen en la p√°gina. -->

    
<!-- Se eliminaron las tarjetas de 'Predicci√≥n de Acopio Mensual' y 'Mes m√°s rentable (ML)' a petici√≥n del usuario. -->

    {% endif %}

</div>
<!-- Debug output for series (visible solo en DEBUG) -->
{% if debug %}
<pre id="series-debug" style="white-space:pre-wrap; background:#f8f9fa; border:1px solid #e9ecef; padding:8px; max-height:300px; overflow:auto;"></pre>
{% endif %}

<!-- Contenedor oculto con los datos de series (evita inyecci√≥n directa de Jinja dentro de JS) -->
<div id="series-data" style="display:none;" data-series='{{ lista_mejores_series | tojson | safe }}'></div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Set progress widths
  document.querySelectorAll('.progress-bar[data-pct]').forEach(function(el){
    const pct = parseFloat(el.getAttribute('data-pct')) || 0;
    el.style.width = pct + '%';
  });

  // Form validation
  const form = document.getElementById('formAnalisis');
  const numVacasInput = document.getElementById('num_vacas_top');
  const razaSelect = document.getElementById('raza_top');
  const numVacasError = document.getElementById('numVacasError');

  if (form) {
    form.addEventListener('submit', function(e){
      let valid = true;
      if (numVacasError) numVacasError.style.display = 'none';

      if (!razaSelect.value) {
        valid = false;
        razaSelect.classList.add('is-invalid');
      } else {
        razaSelect.classList.remove('is-invalid');
      }

      const nv = parseInt(numVacasInput.value, 10);
      if (!nv || nv <= 0) {
        valid = false;
        if (numVacasError) numVacasError.style.display = 'block';
      }

      if (!valid) {
        e.preventDefault();
        e.stopPropagation();
      }
    });
  }

  // Dibujar gr√°ficos por departamento recomendado (si los hay)
  try {
    // Obtener el JSON de las series desde el atributo data- del elemento oculto
    const seriesContainer = document.getElementById('series-data');
    const seriesJson = seriesContainer ? (seriesContainer.dataset.series || '[]') : '[]';
    const seriesData = JSON.parse(seriesJson);
    console.log('lista_mejores_series', seriesData);

    seriesData.forEach(function(s, idx) {
      const canvasId = 'chart-' + idx;
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
  const labels = s.meses.map(m => m.mes);
  const vals = s.meses.map(m => m.valor);
      // Formateador para miles en tooltips y ticks
      const fmt = new Intl.NumberFormat('es-CO');
      new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Acopio (litros)',
            data: vals,
            borderColor: s.has_data ? 'rgba(54, 162, 235, 0.9)' : 'rgba(150,150,150,0.9)',
            backgroundColor: s.has_data ? 'rgba(54, 162, 235, 0.6)' : 'rgba(200,200,200,0.5)',
            borderWidth: 1,
            maxBarThickness: 40,
            barPercentage: 0.75,
            categoryPercentage: 0.85
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { autoSkip: false } },
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) { return fmt.format(value); }
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const v = context.parsed && (context.parsed.y !== undefined ? context.parsed.y : context.parsed);
                  return (context.dataset.label ? context.dataset.label + ': ' : '') + fmt.format(v || 0);
                }
              }
            }
          }
        }
      });
    });
  } catch (err) {
    console.error('Error al renderizar gr√°ficos:', err);
  }
});
</script>

{% endblock %}
