{% extends "base.html" %}
{# Plantilla: Vista de detalle de una consulta guardada.
  Muestra par√°metros, resultados estimados y precios asociados.
  No cambiar el formato de `consulta_data` ya que la vista espera claves concretas. #}
{% block title %}Ver consulta{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-success fw-bold">{{ consulta.titulo }}</h2>
  <p class="text-muted">Creada: {{ consulta.created_at.strftime('%Y-%m-%d %H:%M') if consulta.created_at else '' }}</p>

  <div class="row">
    <div class="col-md-7">
      <div class="card mb-3 shadow-sm">
        <div class="card-header bg-success text-white fw-bold">üìä Resumen de la consulta</div>
        <div class="card-body">
          <h6 class="fw-semibold">Descripci√≥n</h6>
          <p class="text-muted">{{ consulta.descripcion or 'Sin descripci√≥n' }}</p>

          <hr>
          <h6 class="fw-semibold">Par√°metros</h6>
          <div class="row mb-2">
            <div class="col-md-5">
              <label class="form-label small">Raza</label>
              <div class="form-control-plaintext">{{ (consulta_data and consulta_data.get('raza')) or '‚Äî' }}</div>
            </div>
            <div class="col-md-4">
              <label class="form-label small"># Vacas</label>
              <div class="form-control-plaintext">{{ (consulta_data and consulta_data.get('num_vacas')) or '‚Äî' }}</div>
            </div>
            <div class="col-md-3">
              <label class="form-label small">Fecha guardada</label>
              <div class="form-control-plaintext">{{ consulta.created_at.strftime('%Y-%m-%d %H:%M') if consulta.created_at else '‚Äî' }}</div>
            </div>
          </div>

          <label class="form-label small">Departamentos</label>
          <div class="mb-2">
            {% if consulta_data and consulta_data.get('departamentos') %}
              {% for d in consulta_data.get('departamentos') %}
                <span class="badge bg-light text-dark border me-1 mb-1">{{ d }}</span>
              {% endfor %}
            {% else %}
              <p class="text-muted small">No hay departamentos asociados.</p>
            {% endif %}
          </div>

          <hr>
          <h6 class="fw-semibold">Producci√≥n estimada</h6>
          {% if prod_info %}
            <div class="mb-2">
              <div class="row">
                <div class="col-md-4">
                  <label class="form-label small">Estimaci√≥n diaria (total)</label>
                  <div class="form-control-plaintext fw-bold">{{ '{:,.0f}'.format(prod_info.litros_diario_total) }} L/d√≠a</div>
                </div>
                <div class="col-md-4">
                  <label class="form-label small">Estimaci√≥n mensual (total)</label>
                  <div class="form-control-plaintext fw-bold">{{ '{:,.0f}'.format(prod_info.litros_mensual_total) }} L/mes</div>
                </div>
                <div class="col-md-4">
                  <label class="form-label small">Promedio por vaca</label>
                  <div class="form-control-plaintext fw-bold">{{ '{:,.1f}'.format(prod_info.litros_por_vaca_diario) }} L/d√≠a ¬∑ {{ '{:,.0f}'.format(prod_info.litros_por_vaca_mensual) }} L/mes</div>
                </div>
              </div>
            </div>
            {% if prod_info.por_departamento and prod_info.por_departamento|length > 0 %}
              <div class="table-responsive">
                <table class="table table-sm table-hover">
                  <thead><tr><th>Departamento</th><th class="text-end">Precio (COP)</th></tr></thead>
                  <tbody>
                    {% for d in prod_info.por_departamento %}
                      <tr>
                        <td>{{ d.departamento }}</td>
                        <td class="text-end">{% if d.precio %}{{ '{:,.0f}'.format(d.precio) }}{% else %}N/A{% endif %}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endif %}
          {% else %}
            <p class="text-muted">No hay datos suficientes para estimar producci√≥n (falta raza o n√∫mero de vacas).</p>
          {% endif %}

        </div>
      </div>
    </div>

    <div class="col-md-5">
      <div class="card mb-3 shadow-sm">
        <div class="card-header bg-primary text-white fw-bold">üí∞ Departamentos y Precios</div>
        <div class="card-body">
          {% if consulta_data and consulta_data.get('precios_departamentos') %}
            <div class="table-responsive">
              <table class="table table-sm table-hover mb-0">
                <thead><tr><th>Departamento</th><th class="text-end">Precio</th></tr></thead>
                <tbody>
                  {% for p in consulta_data.get('precios_departamentos') %}
                    <tr>
                      <td>{{ p.get('departamento') or '' }}</td>
                      <td class="text-end">{{ p.get('precio_str') or p.get('precio') or 'N/A' }} COP</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-muted">No hay precios asociados a esta consulta.</p>
          {% endif %}
        </div>
      </div>
      <div class="d-grid gap-2">
        <a href="{{ url_for('perfil.mis_consultas') }}" class="btn btn-outline-secondary">Volver</a>
      </div>
    </div>
  </div>
  
</div>
{% endblock %}
{% block scripts %}{% endblock %}
