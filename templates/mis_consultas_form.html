{% extends "base.html" %}
{# Plantilla: formulario para crear/editar una consulta guardada.
  Ofrece una vista "amigable" para completar campos y un textarea
  JSON editable. Mantener los nombres de los campos `titulo`,
  `descripcion` y `query` para que la vista `guardar_consulta` los procese.
#}
{% block title %}{% if consulta %}Editar consulta{% else %}Nueva consulta{% endif %}{% endblock %}

{% block content %}
<div class="card shadow-lg border-0 mb-4 rounded-4">
  <div class="card-body text-center py-3">
    <h2 class="fw-bold text-success mb-1">{% if consulta %}Editar consulta{% else %}Nueva consulta{% endif %}</h2>
    <p class="text-muted small mb-0">Rellena los campos y guarda tu consulta para usarla luego.</p>
  </div>
</div>

<form method="POST" class="mt-3">
    <div class="mb-3">
      <label class="form-label">Título</label>
      <input type="text" name="titulo" class="form-control" value="{{ consulta.titulo if consulta else '' }}" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Descripción</label>
      <textarea name="descripcion" class="form-control" rows="3">{{ consulta.descripcion if consulta else '' }}</textarea>
    </div>
    <div class="mb-3">
      <label class="form-label">Parámetros (vista amigable)</label>
      <div class="row gx-2 gy-2 align-items-center mb-2">
        <div class="col-md-4">
          <label class="form-label small">Raza</label>
          <input type="text" id="friendly_raza" name="friendly_raza" class="form-control" placeholder="Raza" value="{{ (consulta_data and consulta_data.get('raza')) if consulta_data else '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label small"># Vacas</label>
          <input type="number" id="friendly_nv" name="friendly_nv" class="form-control" placeholder="# Vacas" value="{{ (consulta_data and consulta_data.get('num_vacas')) if consulta_data else '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label small">Año</label>
          <input type="number" id="friendly_anio" name="friendly_anio" class="form-control" value="{{ (consulta_data and consulta_data.get('anio')) if consulta_data else '' }}">
        </div>
        <div class="col-md-2 d-grid">
          <button type="button" id="btnApplyFields" class="btn btn-outline-primary">Aplicar a JSON</button>
        </div>
      </div>

      <label class="form-label">Departamentos (lista)</label>
      <div id="friendly_departamentos" class="mb-2">
        {% if consulta_data %}
          {% for d in consulta_data.get('departamentos', []) %}
            <span class="badge bg-light text-dark border me-1 mb-1">{{ d }}</span>
          {% endfor %}
        {% else %}
          <p class="text-muted small">No hay departamentos asociados.</p>
        {% endif %}
      </div>

      <label class="form-label">Query / Parámetros (JSON editable)</label>
      <div class="input-group mb-2">
        <button type="button" id="btnPrettify" class="btn btn-outline-secondary">Formatear JSON</button>
        <button type="button" id="btnValidate" class="btn btn-outline-secondary">Validar</button>
      </div>
      <textarea name="query" id="query_textarea" class="form-control" rows="10" placeholder="JSON, filtros o texto de la consulta">{{ consulta.query_text if consulta else '' }}</textarea>
    </div>
  <div class="d-flex gap-2">
    <button class="btn btn-primary" type="submit">Guardar</button>
    <a href="{{ url_for('perfil.mis_consultas') }}" class="btn btn-outline-secondary">Cancelar</a>
  </div>
</form>
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const ta = document.getElementById('query_textarea');
  const btnPrettify = document.getElementById('btnPrettify');
  const btnValidate = document.getElementById('btnValidate');
  const btnApply = document.getElementById('btnApplyFields');
  const friendlyRaza = document.getElementById('friendly_raza');
  const friendlyNv = document.getElementById('friendly_nv');
  const friendlyAnio = document.getElementById('friendly_anio');
  const friendlyDeps = document.getElementById('friendly_departamentos');
  if (btnPrettify){
    btnPrettify.addEventListener('click', function(){
      try{
        const j = JSON.parse(ta.value || '{}');
        ta.value = JSON.stringify(j, null, 2);
      }catch(e){
        alert('JSON inválido: ' + e.message);
      }
    });
  }
  if (btnValidate){
    btnValidate.addEventListener('click', function(){
      try{ JSON.parse(ta.value || '{}'); alert('JSON válido'); }
      catch(e){ alert('JSON inválido: ' + e.message); }
    });
  }
  if (btnApply){
    btnApply.addEventListener('click', function(){
      // tomar valores amigables y aplicar al textarea JSON
      let j = {};
      try{ j = JSON.parse(ta.value || '{}'); } catch(e){ j = {}; }
      if (friendlyRaza) j.raza = friendlyRaza.value || null;
      if (friendlyNv) j.num_vacas = friendlyNv.value ? parseInt(friendlyNv.value) : null;
      if (friendlyAnio) j.anio = friendlyAnio.value ? parseInt(friendlyAnio.value) : null;
      // departamentos no editable desde aquí (para simplificar)
      ta.value = JSON.stringify(j, null, 2);
      alert('Campos aplicados al JSON. Revisa y guarda.');
    });
  }
});
</script>
{% endblock %}
{% endblock %}
